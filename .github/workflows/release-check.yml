name: TinyTorch Release Check
on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release Type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      check_level:
        description: 'Check Level'
        required: true
        type: choice
        options:
          - quick
          - standard
          - comprehensive

jobs:
  educational-validation:
    name: Educational Standards Review
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest nbformat nbconvert

      - name: Validate Module Structure
        run: |
          echo "ğŸ“ Validating Educational Standards..."
          python .github/scripts/validate_educational_standards.py

      - name: Check Learning Objectives
        run: |
          echo "ğŸ“‹ Checking learning objectives alignment..."
          python .github/scripts/check_learning_objectives.py

      - name: Validate Progressive Disclosure
        run: |
          echo "ğŸ” Validating progressive disclosure patterns..."
          python .github/scripts/check_progressive_disclosure.py

  implementation-validation:
    name: Implementation Standards Review
    runs-on: ubuntu-latest
    needs: educational-validation
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Validate Time Estimates
        run: |
          echo "â±ï¸ Validating time estimate consistency..."
          python .github/scripts/validate_time_estimates.py

      - name: Validate Difficulty Ratings
        run: |
          echo "â­ Validating difficulty rating consistency..."
          python .github/scripts/validate_difficulty_ratings.py

      - name: Check Testing Patterns
        run: |
          echo "ğŸ§ª Checking test_unit_* and test_module() patterns..."
          python .github/scripts/validate_testing_patterns.py

      - name: Validate Dependency Chain
        run: |
          echo "ğŸ”— Validating module dependency chain..."
          python .github/scripts/validate_dependencies.py

      - name: Check NBGrader Metadata
        run: |
          echo "ğŸ“ Validating NBGrader metadata..."
          python .github/scripts/validate_nbgrader.py

  test-validation:
    name: Testing Standards Review
    runs-on: ubuntu-latest
    needs: implementation-validation
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run Unit Tests
        run: |
          echo "ğŸ”¬ Running unit tests..."
          pytest tests/ -v --tb=short

      - name: Run Integration Tests
        run: |
          echo "ğŸ§ª Running integration tests..."
          pytest tests/integration/ -v

      - name: Run Checkpoint Tests
        run: |
          echo "âœ… Running checkpoint validation..."
          pytest tests/checkpoints/ -v

      - name: Check Test Coverage
        run: |
          echo "ğŸ“Š Checking test coverage..."
          pytest tests/ --cov=tinytorch --cov-report=term-missing --cov-fail-under=80

  package-validation:
    name: Package Integration Review
    runs-on: ubuntu-latest
    needs: test-validation
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Validate Export Directives
        run: |
          echo "ğŸ“¦ Validating export directives..."
          python .github/scripts/validate_exports.py

      - name: Check Import Paths
        run: |
          echo "ğŸ”— Checking import path consistency..."
          python .github/scripts/validate_imports.py

      - name: Validate Package Build
        run: |
          echo "ğŸ—ï¸ Testing package build..."
          python -m build

      - name: Test Package Installation
        run: |
          echo "ğŸ“¥ Testing package installation..."
          pip install dist/*.whl
          python -c "import tinytorch; print(f'TinyTorch {tinytorch.__version__} installed')"

  documentation-validation:
    name: Documentation Standards Review
    runs-on: ubuntu-latest
    needs: package-validation
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install sphinx jupyter-book

      - name: Validate Module ABOUT.md Files
        run: |
          echo "ğŸ“„ Validating ABOUT.md consistency..."
          python .github/scripts/validate_documentation.py

      - name: Check Checkpoint Markers
        run: |
          echo "ğŸ Validating checkpoint markers..."
          python .github/scripts/check_checkpoints.py

      - name: Build Jupyter Book
        run: |
          echo "ğŸ“š Building documentation..."
          cd site && jupyter-book build .

  systems-analysis-validation:
    name: Systems Thinking Review
    runs-on: ubuntu-latest
    needs: documentation-validation
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate Memory Analysis
        run: |
          echo "ğŸ§  Checking memory profiling coverage..."
          python .github/scripts/validate_systems_analysis.py --aspect memory

      - name: Validate Performance Analysis
        run: |
          echo "âš¡ Checking performance analysis coverage..."
          python .github/scripts/validate_systems_analysis.py --aspect performance

      - name: Validate Production Context
        run: |
          echo "ğŸš€ Checking production context coverage..."
          python .github/scripts/validate_systems_analysis.py --aspect production

  release-readiness:
    name: Release Readiness Report
    runs-on: ubuntu-latest
    needs: [educational-validation, implementation-validation, test-validation, package-validation, documentation-validation, systems-analysis-validation]
    steps:
      - uses: actions/checkout@v4

      - name: Generate Release Report
        run: |
          echo "ğŸ“‹ Generating Release Readiness Report..."
          cat << EOF > release-report.md
          # TinyTorch Release Readiness Report

          **Release Type:** ${{ github.event.inputs.release_type || 'PR Check' }}
          **Check Level:** ${{ github.event.inputs.check_level || 'standard' }}
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Commit:** ${{ github.sha }}

          ## âœ… Quality Gates Passed

          - âœ… **Educational Standards** - Module structure and learning objectives validated
          - âœ… **Implementation Standards** - Time estimates, difficulty ratings, and patterns consistent
          - âœ… **Testing Standards** - All tests passing with adequate coverage
          - âœ… **Package Integration** - Exports, imports, and build successful
          - âœ… **Documentation** - ABOUT.md files and checkpoints validated
          - âœ… **Systems Analysis** - Memory, performance, and production context present

          ## ğŸ“Š Module Inventory

          **Foundation (01-04):** 4 modules
          - Time: 14-19 hours | Difficulty: â­-â­â­

          **Training Systems (05-08):** 4 modules
          - Time: 24-31 hours | Difficulty: â­â­â­-â­â­â­â­

          **Advanced Architectures (09-13):** 5 modules
          - Time: 26-33 hours | Difficulty: â­â­â­-â­â­â­â­

          **Production Systems (14-20):** 7 modules
          - Time: 36-47 hours | Difficulty: â­â­â­-â­â­â­â­

          **Total:** 20 modules | 100-130 hours

          ## ğŸ¯ Quality Metrics

          - **Test Coverage:** $(pytest tests/ --cov=tinytorch --cov-report=term | grep TOTAL | awk '{print $NF}')
          - **Module Completion:** 20/20 (100%)
          - **Documentation:** Complete
          - **Integration:** Validated

          ## ğŸš€ Release Authorization

          **Status:** âœ… APPROVED FOR RELEASE

          All quality gates passed. TinyTorch is ready for release.

          ---

          *Generated by TinyTorch Release Check Workflow*
          EOF

          cat release-report.md

      - name: Upload Release Report
        uses: actions/upload-artifact@v4
        with:
          name: release-report
          path: release-report.md

      - name: Release Check Summary
        run: |
          echo "âœ… All quality gates passed!"
          echo "ğŸ“¦ TinyTorch is ready for release"
          echo "ğŸ‰ Great work maintaining educational and technical excellence!"
